<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript Levels - Code-X</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="Code-X.html" class="back-button">‚Üê Back</a>
                <h1>JavaScript <span class="accent">Levels</span></h1>
            </div>
            <div class="nav-user">
                <span id="userName">User</span>
                <div class="level-xp">
                    Level <span id="currentLevel">1</span> ‚Ä¢ <span id="currentXP">0</span> XP
                </div>
            </div>
        </nav>

        <main class="level-main">
            <div class="level-container">
                <!-- Level Selector -->
                <div class="level-sidebar">
                    <h3>Levels</h3>
                    <div class="levels-grid" id="levelsGrid">
                        <!-- Levels will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Level Content -->
                <div class="level-content">
                    <div class="level-header">
                        <h2 id="levelTitle">Select a Level</h2>
                        <div class="level-info">
                            <span class="level-number" id="levelNumber">-</span>
                            <span class="level-xp-badge" id="levelXp">0 XP</span>
                        </div>
                    </div>

                    <div class="level-instructions" id="levelInstructions">
                        <p>Select a level from the sidebar to begin your JavaScript learning journey!</p>
                    </div>

                    <div class="coding-area">
                        <div class="code-editor">
                            <div class="editor-header">
                                <span>JavaScript</span>
                                <div class="editor-actions">
                                    <button id="runCode" class="btn btn-primary btn-small">Run Code</button>
                                    <button id="resetCode" class="btn btn-outline btn-small">Reset</button>
                                </div>
                            </div>
                            <textarea id="jsCode" class="code-textarea" placeholder="Write your JavaScript code here..."></textarea>
                        </div>

                        <div class="code-output">
                            <div class="output-header">
                                <span>Console Output</span>
                            </div>
                            <div id="consoleOutput" class="console-output"></div>
                        </div>
                    </div>

                    <div class="level-actions">
                        <button id="checkSolution" class="btn btn-primary" disabled>Check Solution</button>
                        <button id="nextLevel" class="btn btn-outline" disabled>Next Level</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="assets/js/progress.js"></script>
    <script src="assets/js/js-levels.js"></script>
    <script>
        let currentLevel = 1;
        let jsLevels = [];

        function loadLevels() {
            jsLevels = getJsLevels();
            const levelsGrid = document.getElementById('levelsGrid');
            const progress = getProgress();
            
            levelsGrid.innerHTML = '';
            
            for (let i = 1; i <= 100; i++) {
                const level = jsLevels[i - 1];
                const isCompleted = progress.completedLevels.js.includes(i);
                const isUnlocked = i === 1 || progress.completedLevels.js.includes(i - 1);
                
                const levelEl = document.createElement('div');
                levelEl.className = `level-item ${isCompleted ? 'completed' : ''} ${!isUnlocked ? 'locked' : ''} ${i === currentLevel ? 'active' : ''}`;
                levelEl.innerHTML = `
                    <span class="level-item-number">${i}</span>
                    ${isCompleted ? '<span class="level-check">‚úì</span>' : ''}
                `;
                
                if (isUnlocked) {
                    levelEl.addEventListener('click', () => loadLevelContent(i));
                }
                
                levelsGrid.appendChild(levelEl);
            }
        }

        function loadLevelContent(levelNumber) {
            currentLevel = levelNumber;
            const level = jsLevels[levelNumber - 1];
            const progress = getProgress();
            
            // Update UI
            document.getElementById('levelTitle').textContent = level.title;
            document.getElementById('levelNumber').textContent = `Level ${levelNumber}`;
            document.getElementById('levelXp').textContent = `${level.xp} XP`;
            document.getElementById('levelInstructions').innerHTML = level.instructions;
            
            // Set starter code
            document.getElementById('jsCode').value = level.starterCode;
            
            // Update level items
            document.querySelectorAll('.level-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.level-item:nth-child(${levelNumber})`).classList.add('active');
            
            // Enable buttons
            document.getElementById('checkSolution').disabled = false;
            document.getElementById('nextLevel').disabled = !progress.completedLevels.js.includes(levelNumber);
            
            // Clear console
            document.getElementById('consoleOutput').innerHTML = '';
        }

        function runCode() {
            const userCode = document.getElementById('jsCode').value;
            const consoleOutput = document.getElementById('consoleOutput');
            
            // Clear previous output
            consoleOutput.innerHTML = '';
            
            // Override console.log to display in our output
            const originalConsoleLog = console.log;
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                const outputLine = document.createElement('div');
                outputLine.className = 'console-line';
                outputLine.textContent = args.join(' ');
                consoleOutput.appendChild(outputLine);
            };
            
            try {
                // Execute user code
                eval(userCode);
            } catch (error) {
                const errorLine = document.createElement('div');
                errorLine.className = 'console-line error';
                errorLine.textContent = `Error: ${error.message}`;
                consoleOutput.appendChild(errorLine);
            }
            
            // Restore original console.log
            console.log = originalConsoleLog;
        }

        function checkSolution() {
            const userCode = document.getElementById('jsCode').value;
            const level = jsLevels[currentLevel - 1];
            const progress = getProgress();
            
            // Simple validation - in real app, this would test the function outputs
            let passed = true;
            
            // Check for required syntax/patterns
            if (level.requiredPatterns) {
                level.requiredPatterns.forEach(pattern => {
                    if (!userCode.includes(pattern)) {
                        passed = false;
                    }
                });
            }
            
            if (passed) {
                // Level completed!
                if (!progress.completedLevels.js.includes(currentLevel)) {
                    progress.completedLevels.js.push(currentLevel);
                    progress.totalXP += level.xp;
                    progress.totalTime += 5;
                    
                    // Update streak
                    const today = new Date().toDateString();
                    if (progress.lastCompleted !== today) {
                        progress.currentStreak++;
                        progress.lastCompleted = today;
                    }
                    
                    saveProgress(progress);
                    updateAchievements();
                    
                    alert(`üéâ Level ${currentLevel} completed! +${level.xp} XP`);
                }
                
                document.getElementById('nextLevel').disabled = false;
                loadLevels();
            } else {
                alert('‚ùå Not quite right. Check the requirements and try again!');
            }
        }

        function nextLevel() {
            if (currentLevel < 100) {
                loadLevelContent(currentLevel + 1);
            }
        }

        // Event listeners
        document.getElementById('runCode').addEventListener('click', runCode);
        document.getElementById('resetCode').addEventListener('click', () => {
            document.getElementById('jsCode').value = jsLevels[currentLevel - 1].starterCode;
            document.getElementById('consoleOutput').innerHTML = '';
        });
        document.getElementById('checkSolution').addEventListener('click', checkSolution);
        document.getElementById('nextLevel').addEventListener('click', nextLevel);

        // Initialize
        window.addEventListener('load', () => {
            const user = JSON.parse(localStorage.getItem('codex-user'));
            if (!user) {
                window.location.href = 'code-landing.html';
                return;
            }
            
            document.getElementById('userName').textContent = user.name;
            
            const progress = getProgress();
            document.getElementById('currentLevel').textContent = progress.level;
            document.getElementById('currentXP').textContent = progress.totalXP;
            
            loadLevels();
            loadLevelContent(1);
        });
    </script>
</body>
</html>